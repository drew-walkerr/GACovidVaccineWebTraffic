---
title: "CovidVaccineSites"
author: "Drew Walker"
date: "2/6/2021"
output: html_document
---

```{r setup, include=FALSE}
library(tidyverse)
library(jsonlite)
library(knitr)
library(purrr)
library(polite)
library(aws.alexa)
```

# Load Data on GA Vaccine Locations

-   [<https://opendata.atlantaregional.com/datasets/JohnsCreekGA::vaccination-locations-in-georgia/data?geometry=-87.910%2C29.898%2C-78.813%2C36.333>](https://nam11.safelinks.protection.outlook.com/?url=https%3A%2F%2Fopendata.atlantaregional.com%2Fdatasets%2FJohnsCreekGA%3A%3Avaccination-locations-in-georgia%2Fdata%3Fgeometry%3D-87.910%252C29.898%252C-78.813%252C36.333&data=04%7C01%7Candrew.walker%40emory.edu%7Cfb5e2f80f2ae44ab8cab08d8cb19d112%7Ce004fb9cb0a4424fbcd0322606d5df38%7C0%7C0%7C637482659032160171%7CUnknown%7CTWFpbGZsb3d8eyJWIjoiMC4wLjAwMDAiLCJQIjoiV2luMzIiLCJBTiI6Ik1haWwiLCJXVCI6Mn0%3D%7C1000&sdata=3scGweksr%2BqLzj%2FBt%2BQXhe3N8fqY1M5ik9%2B%2BFO622YM%3D&reserved=0 "Original URL: https://opendata.atlantaregional.com/datasets/JohnsCreekGA::vaccination-locations-in-georgia/data?geometry=-87.910%2C29.898%2C-78.813%2C36.333. Click or tap if you trust this link.")

-   

```{r, get_data}

locations <- jsonlite::fromJSON("https://opendata.arcgis.com/datasets/123f98093dd249159bdb635f4b834fc0_0.geojson", flatten = TRUE)

location_list <- locations$features

kable(location_list)
```

# Get site traffic estimations for each site's page on ga public health website

<https://github.com/cloudyr/aws.alexa>

```{r, alexa r package}

creds_raw <- read_csv("rootkey.csv", col_names = FALSE)
creds <- sub("^[^_]*=", "", creds_raw)

test <- head(location_list, n = 20)
test <- location_list

creds_ready <- creds_raw %>% 
  mutate(correct = substring(X1, regexpr("=", X1) + 1, nchar(X1))) %>% 
  select(correct)
set_secret_key(key = creds_ready[1,1], secret = creds_ready[2,1])

test_webdata <- test %>% 
  mutate(web_history = map(test$properties.AdditionalData, traffic_history)) 
#Tidy Version
clinic_web_traffic_data <- test_webdata %>% 
  flatten() %>% 
  unnest(web_history)



test$properties.AdditionalData
```

# COVID-19 GA County Data

```{r, GACOVIDcsv}
temp <- tempfile()
download.file("https://ga-covid19.ondemand.sas.com/docs/ga_covid_data.zip",temp)
ga_county_covid_data <- read_csv(unz(temp, "county_cases.csv")) %>% 
  mutate(date = Sys.Date())
unlink(temp)

download.file("https://ga-covid19.ondemand.sas.com/docs/ga_covid_data.zip",temp)
ga_county_covid_data_demographics_race <- read_csv(unz(temp, "demographics_by_race_eth.csv"))%>% 
  mutate(date = Sys.Date())
unlink(temp)

download.file("https://ga-covid19.ondemand.sas.com/docs/ga_covid_data.zip",temp)
ga_county_covid_data_demographics_race <- read_csv(unz(temp, "demographics_by_race_eth.csv"))%>% 
  mutate(date = Sys.Date())
unlink(temp)

download.file("https://ga-covid19.ondemand.sas.com/docs/ga_covid_data.zip",temp)
ga_county_covid_data_demographics_sex <- read_csv(unz(temp, "demographics_by_sex.csv")) %>% 
  mutate(date = Sys.Date())
unlink(temp)

download.file("https://ga-covid19.ondemand.sas.com/docs/ga_covid_data.zip",temp)
ga_county_covid_data_demographics_age <- read_csv(unz(temp, "demographics_by_age_group.csv")) %>% 
  mutate(date = Sys.Date())
unlink(temp)
```

```{r, write_dataframes}
clinic_web_traffic_data_tibble <- as_tibble(clinic_web_traffic_data)

clinic_web_traffic_data_filename <- paste(Sys.Date(),"clinic_web_traffic_data.rds")

ga_county_covid_data_filename <- paste(Sys.Date(),"ga_county_covid_data.rds")

ga_county_covid_data_demographics_race_filename <- paste(Sys.Date(),"ga_county_covid_data_demographics_race.rds")

ga_county_covid_data_demographics_sex_filename <- paste(Sys.Date(),"ga_county_covid_data_demographics_sex.rds")

ga_county_covid_data_demographics_age_filename <- paste(Sys.Date(),"ga_county_covid_data_demographics_age.rds")



saveRDS(clinic_web_traffic_data, clinic_web_traffic_data_filename)
saveRDS(ga_county_covid_data, ga_county_covid_data_filename)
saveRDS(ga_county_covid_data_demographics_race, ga_county_covid_data_demographics_race_filename)
saveRDS(ga_county_covid_data_demographics_sex, ga_county_covid_data_demographics_sex_filename)
saveRDS(ga_county_covid_data_demographics_age, ga_county_covid_data_demographics_age_filename)

```

# COVID Vaccine Rate for Georgia

-   <https://datastudio.google.com/u/0/reporting/d848d61a-e99e-4961-b040-02b43edc5bb5/page/ptmtB>

-   How to get data pulls from this graphic?

-   
# Google Trends Data r package
- https://cran.r-project.org/web/packages/gtrendsR/gtrendsR.pdf


# Webscraping COVID Vaccine Distribution

https://covid.cdc.gov/covid-data-tracker/#vaccinations 

- There is a download .csv button here, that gives a dated/timestamped set of information on state-by-state vaccine allocation and administration dates. 

# GA Vaccine Allocations PDF by clinic site/County

https://dph.georgia.gov/covid-vaccine
 * May be too difficult to clean/scrape this data 
 
